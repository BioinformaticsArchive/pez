#This may need checking on other systems, because I'm using exact value checks with no consideration of precision...
#Setup
require(testthat)
require(picante)
data(phylocom)
data <- comparative.comm(phylocom$phylo, phylocom$sample, warn=FALSE)
context("shape metrics")

#Tests
test_that("PSV", {
  psv_test <<- shape(data, "psv")
  expect_that(psv_test$psv, equals(c(0.485714285714286, 0.6, 0.714285714285714, 0.828571428571429, 0.885714285714286, 0.842857142857143)))
  expect_that(psv_test$psr, equals(NULL))
  expect_that(psv_test$mpd, equals(NULL))
  expect_that(psv_test$pd, equals(NULL))
  expect_that(psv_test$pd.ivs, equals(NULL))
  expect_that(psv_test$colless, equals(NULL))
  expect_that(psv_test$gamma, equals(NULL))
  expect_that(psv_test$taxon, equals(NULL))
  expect_that(psv_test$eigen.sum, equals(NULL))
  expect_that(psv_test$cadotte.pd, equals(NULL))
})
test_that("PSR", {
  psr_test <<- shape(data, "psr")
  expect_that(psr_test$psv, equals(NULL))
  expect_that(psr_test$psr, equals(c(3.88571428571429, 4.8, 5.71428571428571, 6.62857142857143, 7.08571428571429, 6.74285714285714)))
  expect_that(psr_test$mpd, equals(NULL))
  expect_that(psr_test$pd, equals(NULL))
  expect_that(psr_test$pd.ivs, equals(NULL))
  expect_that(psr_test$colless, equals(NULL))
  expect_that(psr_test$gamma, equals(NULL))
  expect_that(psr_test$taxon, equals(NULL))
  expect_that(psr_test$eigen.sum, equals(NULL))
  expect_that(psr_test$cadotte.pd, equals(NULL))
})
test_that("MPD", {
  mpd_test <<- shape(data, "mpd")
  expect_that(mpd_test$psv, equals(NULL))
  expect_that(mpd_test$psr, equals(NULL))
  expect_that(mpd_test$mpd, equals(c(4.85714285714286, 6, 7.14285714285714, 8.28571428571429, 8.85714285714286, 8.42857142857143)))
  expect_that(mpd_test$pd, equals(NULL))
  expect_that(mpd_test$pd.ivs, equals(NULL))
  expect_that(mpd_test$colless, equals(NULL))
  expect_that(mpd_test$gamma, equals(NULL))
  expect_that(mpd_test$taxon, equals(NULL))
  expect_that(mpd_test$eigen.sum, equals(NULL))
  expect_that(mpd_test$cadotte.pd, equals(NULL))
})
test_that("PD", {
  pd_test <<- shape(data, "pd")
  expect_that(pd_test$psv, equals(NULL))
  expect_that(pd_test$psr, equals(NULL))
  expect_that(pd_test$mpd, equals(NULL))
  expect_that(pd_test$pd, equals(c(16, 17, 18, 22, 30, 27)))
  expect_that(pd_test$pd.ivs, is_equivalent_to(c(-5.66666666666666, -4.66666666666667, -3.66666666666667, 0.333333333333332, 8.33333333333333, 5.33333333333333)))
  expect_that(pd_test$colless, equals(NULL))
  expect_that(pd_test$gamma, equals(NULL))
  expect_that(pd_test$taxon, equals(NULL))
  expect_that(pd_test$eigen.sum, equals(NULL))
  expect_that(pd_test$cadotte.pd, equals(NULL))
})
test_that("Colless", {
  colless_test <<- shape(data, "colless")
  expect_that(colless_test$psv, equals(NULL))
  expect_that(colless_test$psr, equals(NULL))
  expect_that(colless_test$mpd, equals(NULL))
  expect_that(colless_test$pd, equals(NULL))
  expect_that(colless_test$pd.ivs, equals(NULL))
  expect_that(colless_test$colless, is_equivalent_to(c(9, 6, 6, 5, 6, 11)))
  expect_that(colless_test$gamma, equals(NULL))
  expect_that(colless_test$taxon, equals(NULL))
  expect_that(colless_test$eigen.sum, equals(NULL))
  expect_that(colless_test$cadotte.pd, equals(NULL))
})
test_that("Gamma", {
  gamma_test <<- shape(data, "gamma")
  expect_that(gamma_test$psv, equals(NULL))
  expect_that(gamma_test$psr, equals(NULL))
  expect_that(gamma_test$mpd, equals(NULL))
  expect_that(gamma_test$pd, equals(NULL))
  expect_that(gamma_test$pd.ivs, equals(NULL))
  expect_that(gamma_test$colless, equals(NULL))
  expect_that(gamma_test$gamma, is_equivalent_to(c(-1.13137084989848, -1.13137084989848, -1.06066017177982, -1.13137084989848, -2.22233559801486, -1.47078210486802)))
  expect_that(gamma_test$taxon, equals(NULL))
  expect_that(gamma_test$eigen.sum, equals(NULL))
  expect_that(gamma_test$cadotte.pd, equals(NULL))
})
test_that("Taxon", {
  taxon_test <<- shape(data, "taxon")
  expect_that(taxon_test$psv, equals(NULL))
  expect_that(taxon_test$psr, equals(NULL))
  expect_that(taxon_test$mpd, equals(NULL))
  expect_that(taxon_test$pd, equals(NULL))
  expect_that(taxon_test$pd.ivs, equals(NULL))
  expect_that(taxon_test$colless, equals(NULL))
  expect_that(taxon_test$gamma, equals(NULL))
  expect_that(taxon_test$taxon$Species, is_equivalent_to(c(8, 8, 8, 8, 8, 8)))
  expect_that(names(taxon_test$taxon$Species), equals(rownames(data$comm)))
  expect_that(taxon_test$taxon$D, is_equivalent_to(c(7.92857142857143, 8, 7.71428571428571, 8.35714285714286, 8.57142857142857, 7.5)))
  expect_that(names(taxon_test$taxon$D), equals(rownames(data$comm)))
  expect_that(taxon_test$taxon$Dstar, is_equivalent_to(c(c(7.92857142857143, 8, 7.71428571428571, 8.35714285714286, 8.57142857142857, 7.5))))
  expect_that(names(taxon_test$taxon$Dstar), equals(rownames(data$comm)))
  expect_that(taxon_test$taxon$Dplus, is_equivalent_to(c(7.92857142857143, 8, 7.71428571428571, 8.35714285714286, 8.57142857142857, 7.5)))
  expect_that(names(taxon_test$taxon$Dplus), equals(rownames(data$comm)))
  expect_that(taxon_test$taxon$sd.Dplus, is_equivalent_to(c(0.370294155321945, 0.370294155321945, 0.370294155321945, 0.370294155321945, 0.370294155321945, 0.370294155321945)))
  expect_that(taxon_test$taxon$SDplus, is_equivalent_to(c(63.4285714285714, 64, 61.7142857142857, 66.8571428571429, 68.5714285714286, 60)))
expect_that(names(taxon_test$taxon$SDplus), equals(rownames(data$comm)))
  expect_that(taxon_test$taxon$ED, equals(16.25))
  expect_that(taxon_test$taxon$EDstar, equals(7.95212765957447))
  expect_that(taxon_test$taxon$EDplus, equals(8.23333333333333))
  expect_that(class(taxon_test$taxon), equals("taxondive"))
  expect_that(names(taxon_test$taxon), equals(c("Species", "D", "Dstar", "Lambda", "Dplus", "sd.Dplus", "SDplus", "ED", "EDstar", "EDplus")))
  expect_that(taxon_test$eigen.sum, equals(NULL))
  expect_that(taxon_test$cadotte.pd, equals(NULL))
})
test_that("Eigenvectors", {
  set.seed(123)
  eigen.sum <<- shape(data, "eigen.sum")
  expect_that(eigen.sum$psv, equals(NULL))
  expect_that(eigen.sum$psr, equals(NULL))
  expect_that(eigen.sum$mpd, equals(NULL))
  expect_that(eigen.sum$pd, equals(NULL))
  expect_that(eigen.sum$pd.ivs, equals(NULL))
  expect_that(eigen.sum$colless, equals(NULL))
  expect_that(eigen.sum$gamma, equals(NULL))
  expect_that(eigen.sum$taxon, equals(NULL))
  expect_that(eigen.sum$eigen.sum, is_equivalent_to(c(0.0356299767145188, 0.0449253732757101, 0.0398470177258277, 0.0453855691303168, 0.0498549890884496, 0.0226832116649127)))
  set.seed(123)
  expect_that(shape(data, "eigen.sum", 2)$eigen.sum, is_equivalent_to(c(0.0209484841142963, 0.036527380415346, 0.0587577270236274, 0.0492929836486836, 0.0292213010742769, 0.0621021096378085)))
  expect_that(eigen.sum$cadotte.pd, equals(NULL))
})
#We can't thoroughly test these functions because their values change and they seem to be causing errors; perhaps they should be depreciated? The error seems to be coming from ecoPD, not pez...
test_that("Cadotte PD", {
  cadotte.pd <<- shape(data, "cadotte.pd")
  expect_that(cadotte.pd$psv, equals(NULL))
  expect_that(cadotte.pd$psr, equals(NULL))
  expect_that(cadotte.pd$mpd, equals(NULL))
  expect_that(cadotte.pd$pd, equals(NULL))
  expect_that(cadotte.pd$pd.ivs, equals(NULL))
  expect_that(cadotte.pd$colless, equals(NULL))
  expect_that(cadotte.pd$gamma, equals(NULL))
  expect_that(cadotte.pd$taxon, equals(NULL))
  expect_that(cadotte.pd$eigen.sum, equals(NULL))
  expect_that(rownames(cadotte.pd$cadotte.pd), equals(rownames(data$comm)))
  expect_that(colnames(cadotte.pd$cadotte.pd), equals(c("Eed", "Hed")))
  #expect_that(cadotte.pd$cadotte.pd$Eed, is_equivalent_to(c(1, 1, 1, 1, 1, 0.998304366294293)))
  #expect_that(cadotte.pd$cadotte.pd$Hed, is_equivalent_to(c(2.07944154167984, 2.07944154167984, 2.07944154167984, 2.07944154167984, 2.07944154167984, 2.07591557051272)))
})
test_that("Each measure is the same as calculated together", {
  all <- shape(data)
  expect_that(psv_test$psv, equals(all$psv))
  expect_that(psr_test$psr, equals(all$psr))
  expect_that(mpd_test$mpd, equals(all$mpd))
  expect_that(pd_test$pd, equals(all$pd))
  expect_that(pd_test$pd.ivs, equals(all$pd.ivs))
  expect_that(colless_test$colless, equals(all$colless))
  expect_that(gamma_test$gamma, equals(all$gamma))
  expect_that(taxon_test$taxon, equals(all$taxon))
  expect_that(eigen.sum$eigen.sum, equals(all$eigen.sum))
  expect_that(cadotte.pd$cadotte.pd, equals(all$cadotte.pd))
})
